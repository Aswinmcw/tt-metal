# tt_metal profiler

## Usage

For installation and usage please refer to the `pofiler` section under `performance_measurement_tools` of tt_metall docs.

## Internal to TT dev docs

### llrt

1. Under `tests/tt_metal/build_kernels_for_riscv`, for whichever test that you want to profile, enable kernel profiling
through `generate_binaries_all_riscs`

e.g.
```
    constexpr bool profiler_kernel = true;
    generate_binaries_all_riscs(&build_kernel_for_riscv_options, out_dir_path, "grayskull", params, profiler_kernel);
```

2. Under `tests/tt_metal/llrt/`, for whichever test that you want to profile, instantiate a local `Profiler` object,
and call `dumpDeviceResults` after you have finished running your kernels on the same cluster and cores.

e.g.
```
    #include "tools/profiler/profiler.hpp"
    static Profiler data_copy_profiler = Profiler();
    .
    .
    .
    .
    pass &= run_data_copy_multi_tile(cluster, chip_id, core, 2048);

    data_copy_profiler.dumpDeviceResults(cluster, chip_id, cores);

```

### Automation tests for the profiler module

If new changes were made to the post processing scripts, please run automated test to make sure previously supported
measurements still have support.

Automated test are run by:

1. Follow the tt-metal dev get_started and general installation guide and make sure `PYTHONPATH`
   and other tt-metal environment variables are set. Activate the python environment as suggested by the guides.
2. For testing the collection side of the profiler module, run the following commands under `TT_METAL_HOME`:

```
    cd $TT_METAL_HOME
    pytest -svvv tests/tt_metal/tools/profiler/test_device_profiler.py
```

3. For testing the processing side of the profiler module, run the following commands under `TT_METAL_HOME`:

```
    cd $TT_METAL_HOME
    pytest -svvv tests/tt_metal/tools/profiler/test_device_logs.py
```

#### Adding device log file test

Fro device log file test executed by `test_device_logs.py`, when new features are added which require
modifying some or all of the golden artifacts, the following script can be used to populate the golden directory with the new format.

```
    cd $TT_METAL_HOME
    ./tests/tt_metal/tools/profiler/populate_golden.py -w
```

Note that the wipe `-w` option wipes the current golden folder and replaces its content with the new artifacts. This change will
show up in your diff for you PR when pushing the new golden artifacts. Care needs to be taken to make sure the changes are legitimate during the PR process

If new log examples need to be added, their golden artifacts can be generated by:

1. Copy the `.csv` log file to the `tt_metal/third_party/lfs/profiler/tests/golden/device/logs/` folder and name it with this format `profile_log_device_{testName}.csv`
2. Run `populate_golden.py` without the wipe option

Golden artifacts will be generated for the file and the test list file be updated for the new log
